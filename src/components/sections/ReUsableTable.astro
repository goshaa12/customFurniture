---
import Section from "../ui/Section.astro";
import Table from "../ui/Table.astro";
import { reUsableTableData, type ReUsableTableColumn, type ReUsableTableRow } from "../../data/index";
import { generatePriceMarkupFromTable } from "../../utils/schemaMarkup";

interface Props {
  title?: string;
  subtitle?: string;
  table?: {
    columns: ReUsableTableColumn[];
    rows: ReUsableTableRow[];
  };
  additionalText?: string;
  ctaButton?: {
    text: string;
    href: string;
  };
}

// Получаем данные из централизованного хранилища или из props
const defaultData = reUsableTableData;

const {
  title = defaultData.title,
  subtitle = defaultData.subtitle,
  table = defaultData.table,
  additionalText = defaultData.additionalText,
  ctaButton = defaultData.ctaButton,
} = Astro.props;

// Генерируем микроразметку для цен, если таблица содержит цены
const hasPriceColumn = table.columns.some(col => 
  col.header.toLowerCase().includes('цена') || 
  col.header.toLowerCase().includes('стоимость') ||
  col.header.toLowerCase().includes('тенге')
);

const priceMarkup = hasPriceColumn 
  ? generatePriceMarkupFromTable(table.rows, table.columns, title || "Мебель на заказ")
  : null;
---

<Section id="why-us" class="py-24 bg-white">
  <div class="max-w-6xl mx-auto px-4">
    <h2 class="text-3xl md:text-4xl font-bold text-center text-stone-800 mb-8">
      {title}
    </h2>
    {subtitle && (
      <p class="text-stone-600 text-lg md:text-xl mb-12 text-center max-w-3xl mx-auto">
        {subtitle}
      </p>
    )}

    <!-- Таблица сравнения -->
    <div class="mb-12">
      <div class="bg-neutral-50 border border-neutral-200 rounded-3xl p-8 md:p-12 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="text-stone-700 font-semibold border-b">
                {table.columns.map((column, colIndex) => {
                  const isLastColumn = colIndex === table.columns.length - 1;
                  return (
                    <th class={isLastColumn ? "py-3" : "py-3 pr-6"}>
                      {column.header}
                    </th>
                  );
                })}
              </tr>
            </thead>
            <tbody class="text-stone-600 text-sm md:text-base">
              {table.rows.map((row, rowIndex) => (
                <tr class={rowIndex < table.rows.length - 1 ? "border-b" : ""}>
                  {table.columns.map((column, colIndex) => {
                    const isLastColumn = colIndex === table.columns.length - 1;
                    const isFirstColumn = colIndex === 0;
                    const cellValue = row[column.key] ?? "";
                    const linkValue = column.linkKey ? row[column.linkKey] : undefined;
                    
                    let cellClassName = "";
                    if (isFirstColumn) {
                      cellClassName = isLastColumn ? "py-3 font-medium" : "py-3 pr-6 font-medium";
                    } else {
                      cellClassName = isLastColumn ? "py-3 text-stone-800" : "py-3 pr-6 text-stone-800";
                    }
                    
                    return (
                      <td class={cellClassName}>
                        {column.isButton && linkValue ? (
                          <a
                            href={String(linkValue)}
                            class="inline-block bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all"
                          >
                            {cellValue}
                          </a>
                        ) : (
                          cellValue
                        )}
                      </td>
                    );
                  })}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Дополнительный текст и кнопка -->
    {additionalText && (
      <p class="text-stone-600 text-lg md:text-xl mb-8 text-center max-w-3xl mx-auto">
        {additionalText}
      </p>
    )}
    {ctaButton && (
      <div class="text-center">
        <a
          href={ctaButton.href}
          class="inline-block bg-stone-800 text-white py-4 px-8 rounded-full text-lg font-medium hover:bg-stone-700 transition-all"
        >
          {ctaButton.text}
        </a>
      </div>
    )}
  </div>

  {priceMarkup && (
    <script type="application/ld+json" set:html={JSON.stringify(priceMarkup)} />
  )}
</Section>
