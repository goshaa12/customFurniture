---
import Section from "../ui/Section.astro";
import { howItWorksData, iconMap, type WorkStep } from "../../data/index";

interface Props {
  title?: string;
  subtitle?: string;
  steps?: Array<{
    step: string;
    title: string;
    text: string;
    icon: any;
    bg: string;
  }>;
  gridCols?: number;
  ctaButton?: {
    text: string;
    href: string;
  };
}

// Получаем данные из централизованного хранилища или из props
const defaultData = howItWorksData;

const {
  title = defaultData.title,
  subtitle = defaultData.subtitle,
  steps: propSteps,
  gridCols = defaultData.gridCols ?? 3,
  ctaButton = defaultData.ctaButton,
} = Astro.props;

// Функция для получения классов grid в зависимости от количества колонок
const getGridClasses = (cols: number) => {
  const gridMap: Record<number, string> = {
    1: "grid-cols-1",
    2: "md:grid-cols-2",
    3: "md:grid-cols-2 lg:grid-cols-3",
    4: "md:grid-cols-2 lg:grid-cols-4",
  };
  return gridMap[cols] || gridMap[3];
};

// Преобразуем steps из данных (с названиями иконок) в компоненты
// Если steps переданы через props, проверяем нужно ли преобразовать иконки
// Иначе используем defaultData.steps и преобразуем их
const steps = (propSteps || defaultData.steps).map((step: any) => {
  // Если icon уже компонент (не строка), оставляем как есть
  // Если это строка, преобразуем в компонент
  if (typeof step.icon === 'string') {
    return {
      ...step,
      icon: iconMap[step.icon] || iconMap.FileText,
    };
  }
  return step;
});
---

<Section padding='xl' id="how-we-work" class="py-24 px-4 bg-white">
  <div class="max-w-6xl mx-auto px-4 text-center mb-16">
    <h2 class="text-3xl md:text-4xl font-bold text-stone-800 mb-4">
      {title}
    </h2>
    {subtitle && (
      <p class="text-stone-600 text-lg md:text-xl max-w-3xl mx-auto leading-relaxed">
        {subtitle}
      </p>
    )}
  </div>

  <!-- Steps Grid -->
  <div class={`grid ${getGridClasses(gridCols)} gap-8 mb-16`}>
    {steps.map((item) => (
      <div class="group relative bg-neutral-100 rounded-3xl p-8 flex flex-col items-center justify-center space-y-4 hover:bg-neutral-200 transition-all duration-300">
        
        <!-- Gradient Number / Icon -->
        <div class={`w-14 h-14 rounded-full bg-gradient-to-br ${item.bg} flex items-center justify-center text-white font-bold text-lg`}>
          <span>{item.step}</span>
        </div>

        <!-- Icon -->
        <div class="text-stone-800 w-16 h-16">
          <item.icon class="w-16 h-16 mx-auto" />
        </div>

        <!-- Text -->
        <div class="text-center space-y-2">
          <h3 class="text-lg font-semibold text-stone-800">{item.title}</h3>
          <p class="text-stone-600 text-sm leading-relaxed">{item.text}</p>
        </div>
      </div>
    ))}
  </div>

  <!-- CTA Button -->
  <div class="text-center">
    <a href={ctaButton.href} class="inline-block bg-stone-800 text-white py-4 px-8 rounded-full text-lg font-medium hover:bg-stone-700 transition-all">
      {ctaButton.text}
    </a>
  </div>
</Section>