---
import { Star } from "@lucide/astro";
import Section from "../ui/Section.astro";
import Card from "../ui/Card.astro";
import { reviewsData, type ReviewsData, type Review } from "../../data/index";

interface Props {
  title?: string;
  subtitle?: string;
  reviews?: Review[];
  ctaButton?: {
    text: string;
    href: string;
  };
}

const defaultData = reviewsData;

const {
  title = defaultData.title,
  subtitle = defaultData.subtitle,
  reviews = defaultData.reviews,
  ctaButton = defaultData.ctaButton,
} = Astro.props;

// Генерируем инициалы из имени, если не указаны
const getInitial = (author: string, avatarInitial?: string): string => {
  if (avatarInitial) return avatarInitial;
  return author.split(' ')[0]?.[0] || author[0] || '?';
};
---

<Section id="reviews" background="default" padding="xl">
  <div class="text-center space-y-4 mb-12 md:mb-20">
    <h2 class="text-3xl md:text-4xl lg:text-5xl font-bold text-stone-800">
      {title}
    </h2>
    {subtitle && (
      <p class="text-lg md:text-xl text-stone-600 max-w-3xl mx-auto leading-relaxed">
        {subtitle}
      </p>
    )}
  </div>

  <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 md:gap-10">
    {reviews.map((review) => {
      const initial = getInitial(review.author, review.avatarInitial);
      const rating = review.rating || 5;
      const borderColor = review.borderColor || "border-amber-400";
      const avatarColor = review.avatarColor || "from-amber-100 to-yellow-200";
      const textColor = borderColor.includes("pink") ? "text-pink-600" : 
                       borderColor.includes("blue") ? "text-blue-600" : 
                       borderColor.includes("orange") ? "text-orange-600" : 
                       "text-amber-600";
      
      return (
        <Card
          background="white"
          class="relative group rounded-xl shadow-md hover:shadow-lg hover:scale-105 transition duration-300"
        >
          <div class="space-y-6">
            <div class="flex items-center space-x-2 mb-6">
              {Array.from({ length: rating }).map(() => (
                <Star class="w-5 h-5 text-yellow-400 fill-current" />
              ))}
            </div>

            <div class={`pl-4 border-l-4 ${borderColor}`}>
              <p class="text-stone-600 leading-relaxed italic">
                {review.text}
              </p>
            </div>

            <div class="flex items-center space-x-5 pt-6 border-t border-stone-100">
              <div
                class={`w-12 h-12 bg-gradient-to-br ${avatarColor} rounded-full flex items-center justify-center`}
              >
                <span class={`${textColor} font-semibold text-lg`}>{initial}</span>
              </div>
              <div>
                <h4 class="font-semibold text-stone-800">{review.author}</h4>
              </div>
            </div>
          </div>
        </Card>
      );
    })}
  </div>

  {ctaButton && (
    <div class="text-center mt-12">
      <a 
        href={ctaButton.href} 
        class="inline-block bg-stone-800 text-white py-3 px-8 rounded-lg text-base font-medium hover:bg-stone-700 transition-all duration-200 shadow-md hover:shadow-lg"
      >
        {ctaButton.text}
      </a>
    </div>
  )}

  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Product",
    "name": "Мебель на заказ",
    "review": reviews.map((review) => ({
      "@type": "Review",
      "author": {
        "@type": "Person",
        "name": review.author
      },
      "reviewBody": review.text.replace(/«|»/g, '"'),
      "reviewRating": {
        "@type": "Rating",
        "ratingValue": String(review.rating || 5),
        "bestRating": "5",
        "worstRating": "1"
      },
      "datePublished": new Date().toISOString().split('T')[0]
    })),
    "aggregateRating": reviews.length > 0 ? {
      "@type": "AggregateRating",
      "ratingValue": String(
        Math.round(
          (reviews.reduce((sum, r) => sum + (r.rating || 5), 0) / reviews.length) * 10
        ) / 10
      ),
      "reviewCount": String(reviews.length),
      "bestRating": "5",
      "worstRating": "1"
    } : undefined
  })} />
</Section>
